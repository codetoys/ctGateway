<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:等线;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"等线 Light";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"\@等线 Light";}
@font-face
	{font-family:"\@等线";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:8.0pt;
	margin-left:0cm;
	line-height:115%;
	font-size:11.0pt;
	font-family:等线;}
h1
	{mso-style-link:"标题 1 字符";
	margin-top:24.0pt;
	margin-right:0cm;
	margin-bottom:4.0pt;
	margin-left:21.6pt;
	text-indent:-21.6pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:24.0pt;
	font-family:"等线 Light";
	color:#0F4761;
	font-weight:normal;}
h2
	{mso-style-link:"标题 2 字符";
	margin-top:8.0pt;
	margin-right:0cm;
	margin-bottom:4.0pt;
	margin-left:28.8pt;
	text-indent:-28.8pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:20.0pt;
	font-family:"等线 Light";
	color:#0F4761;
	font-weight:normal;}
h3
	{mso-style-link:"标题 3 字符";
	margin-top:8.0pt;
	margin-right:0cm;
	margin-bottom:4.0pt;
	margin-left:36.0pt;
	text-indent:-36.0pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"等线 Light";
	color:#0F4761;
	font-weight:normal;}
h4
	{mso-style-link:"标题 4 字符";
	margin-top:4.0pt;
	margin-right:0cm;
	margin-bottom:2.0pt;
	margin-left:43.2pt;
	text-indent:-43.2pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:等线;
	color:#0F4761;
	font-weight:normal;}
h5
	{mso-style-link:"标题 5 字符";
	margin-top:4.0pt;
	margin-right:0cm;
	margin-bottom:2.0pt;
	margin-left:50.4pt;
	text-indent:-50.4pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:等线;
	color:#0F4761;
	font-weight:normal;}
h6
	{mso-style-link:"标题 6 字符";
	margin-top:2.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:57.6pt;
	text-indent:-57.6pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:等线;
	color:#0F4761;}
p.MsoHeading7, li.MsoHeading7, div.MsoHeading7
	{mso-style-link:"标题 7 字符";
	margin-top:2.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:64.8pt;
	text-indent:-64.8pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:等线;
	color:#595959;
	font-weight:bold;}
p.MsoHeading8, li.MsoHeading8, div.MsoHeading8
	{mso-style-link:"标题 8 字符";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:72.0pt;
	text-indent:-72.0pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:等线;
	color:#595959;}
p.MsoHeading9, li.MsoHeading9, div.MsoHeading9
	{mso-style-link:"标题 9 字符";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:79.2pt;
	text-indent:-79.2pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:等线;
	color:#595959;}
p.MsoToc1, li.MsoToc1, div.MsoToc1
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:8.0pt;
	margin-left:0cm;
	line-height:115%;
	font-size:11.0pt;
	font-family:等线;}
p.MsoToc2, li.MsoToc2, div.MsoToc2
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:8.0pt;
	margin-left:21.0pt;
	line-height:115%;
	font-size:11.0pt;
	font-family:等线;}
p.MsoToc3, li.MsoToc3, div.MsoToc3
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:8.0pt;
	margin-left:42.0pt;
	line-height:115%;
	font-size:11.0pt;
	font-family:等线;}
p.MsoTitle, li.MsoTitle, div.MsoTitle
	{mso-style-link:"标题 字符";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:4.0pt;
	margin-left:0cm;
	text-align:center;
	font-size:28.0pt;
	font-family:"等线 Light";
	letter-spacing:-.5pt;}
p.MsoTitleCxSpFirst, li.MsoTitleCxSpFirst, div.MsoTitleCxSpFirst
	{mso-style-link:"标题 字符";
	margin:0cm;
	text-align:center;
	font-size:28.0pt;
	font-family:"等线 Light";
	letter-spacing:-.5pt;}
p.MsoTitleCxSpMiddle, li.MsoTitleCxSpMiddle, div.MsoTitleCxSpMiddle
	{mso-style-link:"标题 字符";
	margin:0cm;
	text-align:center;
	font-size:28.0pt;
	font-family:"等线 Light";
	letter-spacing:-.5pt;}
p.MsoTitleCxSpLast, li.MsoTitleCxSpLast, div.MsoTitleCxSpLast
	{mso-style-link:"标题 字符";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:4.0pt;
	margin-left:0cm;
	text-align:center;
	font-size:28.0pt;
	font-family:"等线 Light";
	letter-spacing:-.5pt;}
p.MsoSubtitle, li.MsoSubtitle, div.MsoSubtitle
	{mso-style-link:"副标题 字符";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:8.0pt;
	margin-left:0cm;
	text-align:center;
	line-height:115%;
	font-size:14.0pt;
	font-family:"等线 Light";
	color:#595959;
	letter-spacing:.75pt;}
a:link, span.MsoHyperlink
	{color:#467886;
	text-decoration:underline;}
p.MsoTocHeading, li.MsoTocHeading, div.MsoTocHeading
	{margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	line-height:107%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"等线 Light";
	color:#0F4761;}
span.1
	{mso-style-name:"标题 1 字符";
	mso-style-link:"标题 1";
	font-family:"等线 Light";
	color:#0F4761;}
span.2
	{mso-style-name:"标题 2 字符";
	mso-style-link:"标题 2";
	font-family:"等线 Light";
	color:#0F4761;}
span.3
	{mso-style-name:"标题 3 字符";
	mso-style-link:"标题 3";
	font-family:"等线 Light";
	color:#0F4761;}
span.4
	{mso-style-name:"标题 4 字符";
	mso-style-link:"标题 4";
	font-family:"Times New Roman",serif;
	color:#0F4761;}
span.a
	{mso-style-name:"标题 字符";
	mso-style-link:标题;
	font-family:"等线 Light";
	letter-spacing:-.5pt;}
span.a0
	{mso-style-name:"副标题 字符";
	mso-style-link:副标题;
	font-family:"等线 Light";
	color:#595959;
	letter-spacing:.75pt;}
.MsoChpDefault
	{font-size:11.0pt;
	font-family:等线;}
.MsoPapDefault
	{margin-bottom:8.0pt;
	line-height:115%;}
 /* Page Definitions */
 @page WordSection1
	{size:595.3pt 841.9pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	layout-grid:15.6pt;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>

</head>

<body lang=ZH-CN link="#467886" vlink="#96607D" style='word-wrap:break-word;
text-justify-trim:punctuation'>

<div class=WordSection1 style='layout-grid:15.6pt'>

<p class=MsoTitle><span lang=EN-US>ctGateway</span>开发指南</p>

<p class=MsoSubtitle><span lang=EN-US>2025.4.25 </span>版本<span lang=EN-US>1</span></p>

<p class=MsoTocHeading>目录</p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc196505346">1<span
style='color:windowtext;text-decoration:none'>     </span><span lang=EN-US><span
lang=EN-US>概述</span></span><span style='color:windowtext;display:none;
text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>2</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc196505347">2<span
style='color:windowtext;text-decoration:none'>     </span><span lang=EN-US><span
lang=EN-US>准备工作</span></span><span style='color:windowtext;display:none;
text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>2</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc196505348">3<span
style='color:windowtext;text-decoration:none'>     </span><span lang=EN-US><span
lang=EN-US>安装依赖的工具和第三方库</span></span><span style='color:windowtext;display:
none;text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>3</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505349">3.1<span style='color:windowtext;text-decoration:none'>       </span>Make<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>3</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505350">3.2<span style='color:windowtext;text-decoration:none'>       </span>g++<span
style='color:windowtext;display:none;text-decoration:none'>.. </span><span
style='color:windowtext;display:none;text-decoration:none'>3</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505351">3.3<span style='color:windowtext;text-decoration:none'>       </span>zlib<span
style='color:windowtext;display:none;text-decoration:none'>.. </span><span
style='color:windowtext;display:none;text-decoration:none'>3</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505352">3.4<span style='color:windowtext;text-decoration:none'>       </span>unzip<span
style='color:windowtext;display:none;text-decoration:none'>.. </span><span
style='color:windowtext;display:none;text-decoration:none'>3</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505353">3.5<span style='color:windowtext;text-decoration:none'>       </span>libssl(OpenSSL)<span
style='color:windowtext;display:none;text-decoration:none'> </span><span
style='color:windowtext;display:none;text-decoration:none'>3</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505354">3.6<span style='color:windowtext;text-decoration:none'>       </span>mosquitto(MQTT)<span
style='color:windowtext;display:none;text-decoration:none'> </span><span
style='color:windowtext;display:none;text-decoration:none'>3</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505355">3.7<span style='color:windowtext;text-decoration:none'>       </span>gdb<span
style='color:windowtext;display:none;text-decoration:none'>.. </span><span
style='color:windowtext;display:none;text-decoration:none'>4</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505356">3.8<span style='color:windowtext;text-decoration:none'>       </span>libmodbus_rtu_over_tcp<span
style='color:windowtext;display:none;text-decoration:none'>.. </span><span
style='color:windowtext;display:none;text-decoration:none'>4</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc196505357">4<span
style='color:windowtext;text-decoration:none'>     </span><span lang=EN-US><span
lang=EN-US>编译</span></span><span style='color:windowtext;display:none;
text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>4</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc196505358">5<span
style='color:windowtext;text-decoration:none'>     </span><span lang=EN-US><span
lang=EN-US>运行</span></span><span style='color:windowtext;display:none;
text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>6</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc196505359">6<span
style='color:windowtext;text-decoration:none'>     </span><span lang=EN-US><span
lang=EN-US>交叉编译</span></span><span style='color:windowtext;display:none;
text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>6</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc196505360">7<span
style='color:windowtext;text-decoration:none'>     </span><span lang=EN-US><span
lang=EN-US>源码结构</span></span><span style='color:windowtext;display:none;
text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>7</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505361">7.1<span style='color:windowtext;text-decoration:none'>       </span>ctGateway<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>7</span></a></span></p>

<p class=MsoToc3 style='margin-left:44.0pt'><span lang=EN-US><a
href="#_Toc196505362">7.1.1<span style='color:windowtext;text-decoration:none'>        </span>third<span
style='color:windowtext;display:none;text-decoration:none'>.. </span><span
style='color:windowtext;display:none;text-decoration:none'>7</span></a></span></p>

<p class=MsoToc3 style='margin-left:44.0pt'><span lang=EN-US><a
href="#_Toc196505363">7.1.2<span style='color:windowtext;text-decoration:none'>        </span>lib<span
style='color:windowtext;display:none;text-decoration:none'>.. </span><span
style='color:windowtext;display:none;text-decoration:none'>7</span></a></span></p>

<p class=MsoToc3 style='margin-left:44.0pt'><span lang=EN-US><a
href="#_Toc196505364">7.1.3<span style='color:windowtext;text-decoration:none'>        </span>gateway<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>7</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505365">7.2<span style='color:windowtext;text-decoration:none'>       </span>doc<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>8</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505366">7.3<span style='color:windowtext;text-decoration:none'>       </span>ManageTools<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>8</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc196505367">8<span
style='color:windowtext;text-decoration:none'>     </span><span lang=EN-US><span
lang=EN-US>全流程模拟运行</span></span><span style='color:windowtext;display:none;
text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>8</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505368">8.1<span style='color:windowtext;text-decoration:none'>       </span><span
lang=EN-US><span lang=EN-US>建立MQTT</span></span><span lang=EN-US><span
lang=EN-US>服务</span></span><span style='color:windowtext;display:none;
text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>8</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505369">8.2<span style='color:windowtext;text-decoration:none'>       </span><span
lang=EN-US><span lang=EN-US>以测试模式运行网关程序</span></span><span style='color:windowtext;
display:none;text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>9</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505370">8.3<span style='color:windowtext;text-decoration:none'>       </span><span
lang=EN-US><span lang=EN-US>修改配置文件</span></span><span style='color:windowtext;
display:none;text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>10</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505371">8.4<span style='color:windowtext;text-decoration:none'>       </span>MQTT
topic<span lang=EN-US><span lang=EN-US>规则</span></span><span style='color:windowtext;
display:none;text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>11</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc196505372">9<span
style='color:windowtext;text-decoration:none'>     </span><span lang=EN-US><span
lang=EN-US>使用网关管理工具ManageTools</span></span><span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>11</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505373">9.1<span style='color:windowtext;text-decoration:none'>       </span><span
lang=EN-US><span lang=EN-US>编译和配置</span></span><span style='color:windowtext;
display:none;text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>11</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505374">9.2<span style='color:windowtext;text-decoration:none'>       </span><span
lang=EN-US><span lang=EN-US>启动</span></span><span style='color:windowtext;
display:none;text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>12</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505375">9.3<span style='color:windowtext;text-decoration:none'>       </span><span
lang=EN-US><span lang=EN-US>主界面</span></span><span style='color:windowtext;
display:none;text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>13</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505376">9.4<span style='color:windowtext;text-decoration:none'>       </span><span
lang=EN-US><span lang=EN-US>网关详情</span></span><span style='color:windowtext;
display:none;text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>13</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505377">9.5<span style='color:windowtext;text-decoration:none'>       </span><span
lang=EN-US><span lang=EN-US>文件同步</span></span><span style='color:windowtext;
display:none;text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>14</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505378">9.6<span style='color:windowtext;text-decoration:none'>       </span><span
lang=EN-US><span lang=EN-US>查看网关程序内部信息</span></span><span style='color:windowtext;
display:none;text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>14</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc196505379">10<span
style='color:windowtext;text-decoration:none'>          </span><span
lang=EN-US><span lang=EN-US>源码指引</span></span><span style='color:windowtext;
display:none;text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>15</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505380">10.1<span style='color:windowtext;text-decoration:none'>        </span><span
lang=EN-US><span lang=EN-US>编译ctfc</span></span><span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>15</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505381">10.2<span style='color:windowtext;text-decoration:none'>        </span><span
lang=EN-US><span lang=EN-US>编译gateway</span></span><span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>15</span></a></span></p>

<p class=MsoToc2 style='margin-left:22.0pt'><span lang=EN-US><a
href="#_Toc196505382">10.3<span style='color:windowtext;text-decoration:none'>        </span><span
lang=EN-US><span lang=EN-US>源码入口点</span></span><span style='color:windowtext;
display:none;text-decoration:none'>.... </span><span
style='color:windowtext;display:none;text-decoration:none'>15</span></a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><a name="_Toc196505346"><span lang=EN-US>1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>概述</a></h1>

<p class=MsoNormal style='margin-left:21.0pt'>项目的<span lang=EN-US>GIT</span>库下包括网关程序、网关管理工具和文档三个目录。</p>

<p class=MsoNormal style='margin-left:21.0pt'>网关管理工具是<span lang=EN-US>C#</span>项目，<span
lang=EN-US>windows</span>程序，目前仅作为辅助工具使用。</p>

<p class=MsoNormal style='margin-left:21.0pt'>网关程序位于<span lang=EN-US>ctGateway</span>目录（与项目同名）。</p>

<p class=MsoNormal style='margin-left:21.0pt'>网关程序运行在<span lang=EN-US>linux</span>系统上，支持<span
lang=EN-US>x86-64</span>、<span lang=EN-US>Arm</span>、<span lang=EN-US>Arm64</span>。</p>

<h1><a name="_Toc196505347"><span lang=EN-US>2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>准备工作</a></h1>

<p class=MsoNormal style='text-indent:21.0pt'>网关程序在<span lang=EN-US>linux</span>上编译运行，建议使用<span
lang=EN-US>Ubuntu18.04</span>，可以在<span lang=EN-US>Ubuntu</span>官网下载<span
lang=EN-US>ubuntu-18.04.6-live-server-amd64.iso</span>。</p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>Visual Studio </span>项目仅用来编辑源代码，需要使用<span
lang=EN-US>VS 2022</span>，社区版即可。</p>

<p class=MsoNormal style='margin-left:21.0pt'>依赖如下几个第三方库（需要下载源码编译）：</p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=277 valign=top style='width:207.4pt;border:solid windowtext 1.0pt;
  background:#0F9ED5;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span
  style='color:black'>名称</span></p>
  </td>
  <td width=277 valign=top style='width:207.4pt;border:solid windowtext 1.0pt;
  border-left:none;background:#0F9ED5;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span
  style='color:black'>版本</span></p>
  </td>
 </tr>
 <tr>
  <td width=277 valign=top style='width:207.4pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span
  lang=EN-US>openssl</span></p>
  </td>
  <td width=277 valign=top style='width:207.4pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span
  lang=EN-US>1.1.1k</span></p>
  </td>
 </tr>
 <tr>
  <td width=277 valign=top style='width:207.4pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span
  lang=EN-US>zlib</span></p>
  </td>
  <td width=277 valign=top style='width:207.4pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span
  lang=EN-US>1.2.11</span></p>
  </td>
 </tr>
 <tr>
  <td width=277 valign=top style='width:207.4pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span
  lang=EN-US>mosquitto</span></p>
  </td>
  <td width=277 valign=top style='width:207.4pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span
  lang=EN-US>2.0.18</span></p>
  </td>
 </tr>
 <tr>
  <td width=277 valign=top style='width:207.4pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span
  lang=EN-US>libmodbus-rtu-over-tcp</span></p>
  </td>
  <td width=277 valign=top style='width:207.4pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'>版本不明确，取最新版</p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>       </span>可以在编译网关程序遇到问题时再根据需要安装第三方库和依赖的工具软件。</p>

<h1><a name="_Toc196505348"><span lang=EN-US>3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>安装依赖的工具和第三方库</a></h1>

<h2><a name="_Toc196505349"><span lang=EN-US>3.1<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>Make</span></a></h2>

<p class=MsoNormal style='margin-left:21.0pt'>最小化的<span lang=EN-US>ubuntu</span>安装没有编译工具，需要安装。</p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>sudo apt install make</span></p>

<h2><a name="_Toc196505350"><span lang=EN-US>3.2<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>g++</span></a></h2>

<p class=MsoNormal style='margin-left:21.0pt'>安装<span lang=EN-US>g++</span>编译器，需要支持<span
lang=EN-US>C++11</span>的版本（当然一般都是支持的）。</p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>sudo apt install
build-essential</span><span lang=EN-US> </span>（<span lang=EN-US>g++</span>，这个应该包含了<span
lang=EN-US>make</span>）</p>

<h2><a name="_Toc196505351"><span lang=EN-US>3.3<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>zlib</span></a></h2>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>sudo apt install
zlib1g-dev</span><span lang=EN-US> </span>（解决<span lang=EN-US>-lz</span>需要）</p>

<h2><a name="_Toc196505352"><span lang=EN-US>3.4<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>unzip</span></a></h2>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>sudo apt install
unzip</span><span lang=EN-US> </span>（安装<span lang=EN-US>libmodbus_rtu_over_tcp-master.zip</span>需要）</p>

<h2><a name="_Toc196505353"><span lang=EN-US>3.5<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>libssl(OpenSSL)</span></a></h2>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>sudo apt install
libssl-dev</span><span lang=EN-US> </span>（默认没有安装头文件和库）</p>

<h2><a name="_Toc196505354"><span lang=EN-US>3.6<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>mosquitto(MQTT)</span></a></h2>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>tar -zxvf
mosquitto-2.0.18.tar.gz</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>cd mosquitto-2.0.18</span></p>

<p class=MsoNormal>修改<span lang=EN-US>config.mk WITH_CJSON:=no</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>make</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>sudo make install</span></p>

<h2><a name="_Toc196505355"><span lang=EN-US>3.7<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>gdb</span></a></h2>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>gdb</span>调试工具，开发经常用到，不是必须的。</p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>sudo apt install gdb</span></p>

<h2><a name="_Toc196505356"><span lang=EN-US>3.8<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>libmodbus_rtu_over_tcp</span></a></h2>

<p class=MsoNormal style='margin-left:21.0pt'>这是<span lang=EN-US>libmodbus</span>的一个衍生版，支持<span
lang=EN-US>rtu over tcp</span>。</p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>unzip
libmodbus_rtu_over_tcp-master.zip</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>cd
libmodbus_rtu_over_tcp-master</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>chmod 755 *.sh</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>./autogen.sh</span></p>

<p class=MsoNormal>如果没有安装<span lang=EN-US>autoconif</span>则<span lang=EN-US>
sudo apt-get install autoconf libtool </span>再重新<span lang=EN-US>./autogen.sh</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>./configure </span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>make install</span></p>

<h1><a name="_Toc196505357"><span lang=EN-US>4<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>编译</a></h1>

<p class=MsoNormal style='text-indent:21.0pt'>环境可能需要预先设置一下，比如启用<span
lang=EN-US>coredump</span>文件、环境变量增加当前目录、设置<span lang=EN-US>LD_LIBRARY_PATH</span>，大概类似如下代码：</p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>ulimit -c unlimited</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>export PATH=.:$PATH</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>export
LD_LIBRARY_PATH=/usr/local/lib/:$LD_LIBRARY_PATH</span></p>

<p class=MsoNormal><span lang=EN-US>       </span>可以放在<span lang=EN-US>.profile</span>，也可以每次登录后手工执行一遍。</p>

<p class=MsoNormal><span lang=EN-US>       </span>源代码<span lang=EN-US>ctGateway</span>目录下的<span
lang=EN-US>gageway</span>、<span lang=EN-US>lib</span>和<span lang=EN-US>third</span>三个目录上传至用户主目录下的<span
lang=EN-US>my</span>目录（当然你可以选择别的目录，不过下面的代码需要相应修改）：</p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>cd</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>cd
my/third/ctfc/platform</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>make -f makefile.mk
linux debug</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>cd ../src</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>chmod 755 *.sh</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>makeall.sh</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>cd ../../../gateway</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>chmod 755 *.sh</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>makeall.sh</span></p>

<p class=MsoNormal><span lang=EN-US>       </span>如果编译成功，最后的输出如下：</p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>date;date;g++ -g
-L../../lib/  -o gwmain.exe gwmain_t.o -Wl,-E -L../../third/ctfc/lib/ -lgwmain
-lgwbuiltin -lmodbus -lmyhttpd -lenv -lmosquittopp -lmosquitto -lgmssl -lssl
-lcrypto -lz -lpthread -ldl  -latomic -lstdc++</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>Thu Apr 24 21:33:26
CST 2025</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>Thu Apr 24 21:33:26
CST 2025</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>date;mv gwmain.exe
../bin</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>Thu Apr 24 21:33:26
CST 2025</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>make[1]: Leaving
directory '/home/user/my/gateway/gwmain'</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>--------</span><span
style='color:#0F9ED5'>编译目录<span lang=EN-US> gwmain </span>完成</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>gwBuiltIn gwprotocol
gwmain</span></p>

<p class=MsoNormal><span style='color:#0F9ED5'>检查结果。。。。。。</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>Thu Apr 24 21:33:26
CST 2025</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>total 27356</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>-rw-rw-r-- 1 user
user  9147734 Apr 24 21:33 libgwbuiltin.a</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>-rw-rw-r-- 1 user
user 17686232 Apr 24 21:33 libgwmain.a</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>-rwxrwxr-x 1 user
user  1034128 Apr 24 21:33 libprotocol_demo.so</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>-rwxrwxr-x 1 user
user   118168 Apr 24 21:33 libtestso2.so</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>-rwxrwxr-x 1 user
user    12512 Apr 24 21:33 libtestso.so</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>-rw-rw-r-- 1 user
user       12 Apr 22 22:23 readme.txt</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>total 8696</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>-rwxrwxr-x 1 user
user 8903944 Apr 24 21:33 gwmain.exe</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>bin/gwmain.exe: ELF
64-bit LSB shared object, x86-64, version 1 (GNU/Linux), dynamically linked, interpreter
/lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0,
BuildID[sha1]=00f6bf8238b570b89db1837e76c4da07c97ba672, with debug_info, not
stripped</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>user@vm-ubuntu:~/my/gateway$</span></p>

<h1><a name="_Toc196505358"><span lang=EN-US>5<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>运行</a></h1>

<p class=MsoNormal style='text-indent:21.0pt'>复制<span lang=EN-US>sn</span>文件，否则无法运行：</p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>cd ;sudo cp
my/gateway/home/* /home/</span></p>

<p class=MsoNormal style='margin-left:21.0pt'>编译成功后进入<span lang=EN-US>publish</span>目录运行如下指令：</p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>../bin/gwmain.exe</span></p>

<p class=MsoNormal><span lang=EN-US>       </span>如果程序能够运行，前几行输出如下：</p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>user@vm-ubuntu:~/my/gateway/publish$
../bin/gwmain.exe $1 $2 $3 $4 $5 $6 $7 $8 $9</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>[04-24
22:19:28][main][</span><span style='color:#0F9ED5'>信息<span lang=EN-US>][gwmain_t.cpp           
: 133(_main)][  0.00]</span>字节序<span lang=EN-US> Little-Endian</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>[04-24
22:19:28][main][</span><span style='color:#0F9ED5'>信息<span lang=EN-US>][gwmain_t.cpp           
: 150(_main)][  0.00]</span>网关程序版本<span lang=EN-US> 1.0.0 2025.04.15 14:39</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>[04-24
22:19:28][main][</span><span style='color:#0F9ED5'>信息<span lang=EN-US>][gwmain_t.cpp           
: 152(_main)][  0.00]</span>工作目录<span lang=EN-US> /home/user/my/gateway/publish</span></span></p>

<h1><a name="_Toc196505359"><span lang=EN-US>6<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>交叉编译</a></h1>

<p class=MsoNormal style='text-indent:21.0pt'>本项目在不同的<span lang=EN-US>arm32</span>和<span
lang=EN-US>arm64</span>交叉编译工具链下编译过，原则上没什么特别的，按照常规方法将所有依赖库和程序交叉编译即可。</p>

<h1><a name="_Toc196505360"><span lang=EN-US>7<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>源码结构</a></h1>

<h2><a name="_Toc196505361"><span lang=EN-US>7.1<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>ctGateway</span></a></h2>

<p class=MsoNormal style='margin-left:21.0pt'>网关程序。</p>

<h3><a name="_Toc196505362"><span lang=EN-US>7.1.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>third</span></a></h3>

<p class=MsoNormal style='text-indent:21.0pt'>第三方依赖库，其中<span lang=EN-US>ctfc</span>是<span
lang=EN-US>git</span>子模块，包含公共基础代码和编译体系。其余目录是依赖的第三方库的头文件，方便编写代码，但是要注意，这些头文件必须和链接的第三方库的版本一致。</p>

<h4><span lang=EN-US>7.1.1.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>ctfc</span></h4>

<p class=MsoNormal style='text-indent:21.0pt'>本项目除了使用的<span lang=EN-US>ctfc</span>的功能外还使用了<span
lang=EN-US>ctfc</span>的编译体系。</p>

<p class=MsoNormal style='margin-left:21.0pt;text-indent:21.0pt'>其编译脚本位于<span
lang=EN-US>ctfc/platform</span>，核心是<span lang=EN-US>config.mk</span>，每个平台的特征由一个单独的<span
lang=EN-US>.mk</span>文件定义，如<span lang=EN-US>linux.mk</span>，另外优化开关由<span
lang=EN-US>fast.mk</span>和<span lang=EN-US>debug.mk</span>定义。</p>

<p class=MsoNormal style='margin-left:21.0pt;text-indent:21.0pt'><span
lang=EN-US>makefile.mk</span>的功能实际上是把平台配置和优化配置复制到<span lang=EN-US>platform.mk</span>和<span
lang=EN-US>optimize.mk</span>。</p>

<p class=MsoNormal style='margin-left:21.0pt;text-indent:21.0pt'>源码中的<span
lang=EN-US>arm.mk</span>和<span lang=EN-US>arm64.mk</span>是两个特定的交叉编译工具链的配置，除非恰好使用同样的交叉编译工具链，否则没有实际意义。</p>

<h3><a name="_Toc196505363"><span lang=EN-US>7.1.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>lib</span></a></h3>

<p class=MsoNormal style='margin-left:21.0pt'>这个目录是用来输出编译产生的库文件的。</p>

<h3><a name="_Toc196505364"><span lang=EN-US>7.1.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>gateway</span></a></h3>

<p class=MsoNormal style='margin-left:21.0pt'>网关程序的源代码。</p>

<h4><span lang=EN-US>7.1.3.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>gwBuiltIn</span></h4>

<p class=MsoNormal style='margin-left:21.0pt'>内置协议，包括<span lang=EN-US>Modbus</span>和隧道协议。编译为静态库。</p>

<h4><span lang=EN-US>7.1.3.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>gwmain</span></h4>

<p class=MsoNormal style='margin-left:21.0pt'>程序框架，包括核心基础功能、配置、<span
lang=EN-US>MQTT</span>等。</p>

<h4><span lang=EN-US>7.1.3.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>pwprotocol</span></h4>

<p class=MsoNormal style='margin-left:21.0pt'>外挂协议，编译为动态库。有一个演示协议驱动。</p>

<h4><span lang=EN-US>7.1.3.4<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>home</span></h4>

<p class=MsoNormal style='text-indent:21.0pt'>硬件相关的文件，包括型号、序列号、<span
lang=EN-US>SIM</span>卡信息等，这些由硬件提供，实际可能需要根据硬件修改。源码的这些文件放在合适的位置供虚拟机使用。</p>

<h4><span lang=EN-US>7.1.3.5<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>interface</span></h4>

<p class=MsoNormal style='margin-left:21.0pt'>编写协议驱动所需的接口。</p>

<h4><span lang=EN-US>7.1.3.6<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>publish</span></h4>

<p class=MsoNormal style='text-indent:21.0pt'>运行目录，包含了配置文件和<span lang=EN-US>www</span>服务所需的静态文件。其中<span
lang=EN-US>SSL</span>目录下是<span lang=EN-US>MQTTS</span>所需的证书，<span lang=EN-US>wwwroot</span>是<span
lang=EN-US>www</span>服务的虚拟根目录，<span lang=EN-US>ca.cer</span>、<span lang=EN-US>server.cer</span>、<span
lang=EN-US>server.key</span>是<span lang=EN-US>HTTPS</span>所需的证书。</p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>prefilledkey.txt</span>是国密<span
lang=EN-US>sm4</span>的预充注密钥（就是编了号的一堆密钥）。</p>

<p class=MsoNormal style='text-indent:21.0pt'>几个<span lang=EN-US>json</span>文件是配置文件。</p>

<h2><a name="_Toc196505365"><span lang=EN-US>7.2<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>doc</span></a></h2>

<p class=MsoNormal style='margin-left:21.0pt'>文档。</p>

<h2><a name="_Toc196505366"><span lang=EN-US>7.3<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>ManageTools</span></a></h2>

<p class=MsoNormal style='text-indent:21.0pt'>网关管理工具，独立<span lang=EN-US>C#</span>项目，只包含配置文件和程序入口点，实质性功能由依赖的<span
lang=EN-US>nuget</span>包实现。</p>

<h1><a name="_Toc196505367"><span lang=EN-US>8<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>全流程模拟运行</a></h1>

<h2><a name="_Toc196505368"><span lang=EN-US>8.1<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span>建立<span lang=EN-US>MQTT</span>服务</a></h2>

<p class=MsoNormal style='margin-left:21.0pt'>本项目对<span lang=EN-US>MQTT</span>服务没有特别要求，例如可以使用<span
lang=EN-US>EMQX</span>。</p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>EMQX</span>安装使用非常简单。</p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>https://www.emqx.io/zh/downloads?os=Windows</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>1</span></p>

<p class=MsoNormal><span style='color:#00B0F0'>下载<span lang=EN-US>
emqx-5.0.14-windows-amd64.tar.gz </span>，解压</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>2</span></p>

<p class=MsoNormal><span style='color:#00B0F0'>命令行下进入解压路径，启动<span lang=EN-US>
EMQX</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>cd c:\emqx</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>./bin/emqx start</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>&nbsp;</span></p>

<p class=MsoNormal><span style='color:#00B0F0'>进入<span lang=EN-US>bin</span>目录执行也可以</span></p>

<p class=MsoNormal><span style='color:#00B0F0'>注意控制台可能不从当前目录查找命令文件，必须加<span
lang=EN-US>.\</span>或<span lang=EN-US>./</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>&nbsp;</span></p>

<p class=MsoNormal><span style='color:#00B0F0'>停止<span lang=EN-US> stop</span></span></p>

<p class=MsoNormal><span style='color:#00B0F0'>启动并进入控制台<span lang=EN-US>
console</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>Dashboard</span><span
style='color:#00B0F0'>（<span lang=EN-US>WEB</span>界面）</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>http://localhost:18083/</span></p>

<p class=MsoNormal><span style='color:#00B0F0'>默认用户名密码：<span lang=EN-US>admin/public</span>（在<span
lang=EN-US>etc</span>目录下的配置文件里面）</span></p>

<p class=MsoNormal><span style='color:#00B0F0'>登录后要求修改密码，改为<span lang=EN-US>admin123</span></span></p>

<p class=MsoNormal><span style='color:#00B0F0'>在最下面一个菜单设置显示语言和颜色，可以设置为中文和亮色</span></p>

<p class=MsoNormal><span style='color:#00B0F0'>创建用户<span lang=EN-US>user/user1234</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>&nbsp;</span></p>

<p class=MsoNormal><span style='color:#00B0F0'>默认端口<span lang=EN-US>1883</span>，要从配置文件修改，要重启电脑才能生效</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>&nbsp;</span></p>

<p class=MsoNormal><span style='color:#00B0F0'>客户端软件</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B0F0'>MQTTX-Setup-1.8.0-x64.exe</span></p>

<h2><a name="_Toc196505369"><span lang=EN-US>8.2<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span>以测试模式运行网关程序</a></h2>

<p class=MsoNormal style='text-indent:21.0pt'>以测试模式运行网关程序需要增加“<span lang=EN-US>-test</span>”参数，从而启动内置的<span
lang=EN-US>modbus-TCP</span>服务。默认设置包含对内置<span lang=EN-US>modbus-TCP</span>服务的访问。</p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>cd ; cd
my/gateway/publish</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>../bin/gwmain.exe
-test</span></p>

<p class=MsoNormal><span lang=EN-US>       </span>如果程序成功运行，输出信息的最初几行如下：</p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>user@vm-ubuntu:~/my/gateway/publish$
../bin/gwmain.exe -test</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>[04-25
14:15:16][main][</span><span style='color:#0F9ED5'>信息<span lang=EN-US>][gwmain_t.cpp           
: 133(_main)][  0.00]</span>字节序<span lang=EN-US> Little-Endian</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>[04-25
14:15:16][main][</span><span style='color:#0F9ED5'>信息<span lang=EN-US>][gwmain_t.cpp           
: 150(_main)][  0.00]</span>网关程序版本<span lang=EN-US> 1.0.0 2025.04.15 14:39</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>[04-25
14:15:16][main][</span><span style='color:#0F9ED5'>信息<span lang=EN-US>][gwmain_t.cpp           
: 152(_main)][  0.00]</span>工作目录<span lang=EN-US> /home/user/my/gateway/publish</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>[04-25 14:15:16][TEST
SERVER][</span><span style='color:#0F9ED5'>信息<span lang=EN-US>][gwmain_test.cpp        
: 289(gwmain_test)][  0.00]</span>主进程<span lang=EN-US> 2229 </span>服务进程<span
lang=EN-US> 2230</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>[04-25
14:15:21][main][</span><span style='color:#0F9ED5'>信息<span lang=EN-US>][gwmain_test.cpp        
: 352(gwmain_test)][  0.00]</span>服务进程已创建</span></p>

<p class=MsoNormal><span lang=EN-US>       </span>多了一个服务进程。</p>

<h2><a name="_Toc196505370"><span lang=EN-US>8.3<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span>修改配置文件</a></h2>

<p class=MsoNormal style='margin-left:21.0pt'>默认的北向配置文件<span lang=EN-US>defaultNorthConfig.json</span>如下：</p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>{</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>       &quot;func&quot;:
&quot;connt&quot;,</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>       &quot;data&quot;:
{</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>              &quot;comment&quot;:
&quot;</span><span style='color:#0F9ED5'>本机测试<span lang=EN-US>&quot;,</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>              &quot;type&quot;:
&quot;MQTTS&quot;,</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>              &quot;platform&quot;:
&quot;localtest&quot;,</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>              &quot;hostname&quot;:
&quot;mqtt.test.com&quot;,</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>              &quot;port&quot;:
&quot;8883&quot;,</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>              &quot;userid&quot;:
&quot;user&quot;,</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>              &quot;upwd&quot;:
&quot;user1234&quot;,</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>              &quot;ntp&quot;:
&quot;time.windows.com&quot;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>       }</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>}</span></p>

<p class=MsoNormal><span lang=EN-US>       </span>配置项的含义都很简单明了，需要把<span
lang=EN-US>MQTT</span>的主机名、端口、用户名、密码都设置正确。“<span lang=EN-US>type</span>”为连接平台的方式，可选值为“<span
lang=EN-US>MQTT</span>”或“<span lang=EN-US>MQTTS</span>”。“<span lang=EN-US>platform</span>”为平台的名称，对应<span
lang=EN-US>SSL</span>目录下同名子目录，如果使用<span lang=EN-US>MQTTS</span>，需要替换掉这个目录下的证书文件。</p>

<p class=MsoNormal><span lang=EN-US>       </span>配置正确后应该能从<span lang=EN-US>MQTT</span>服务器的管理工具上看到客户端连接，使用<span
lang=EN-US>MQTT</span>客户端能观察到网关程序发送的数据。</p>

<p class=MsoNormal><span lang=EN-US>       </span>不要直接修改<span lang=EN-US>defaultNorthConfig.json</span>，复制为<span
lang=EN-US>northConfig.json</span>来修改。程序首先查找<span lang=EN-US>northConfig.json</span>，找不到才会使用<span
lang=EN-US>defaultNorthConfig.json</span>。</p>

<h2><a name="_Toc196505371"><span lang=EN-US>8.4<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>MQTT topic</span>规则</a></h2>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=277 valign=top style='width:207.4pt;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span
  lang=EN-US>device_gateway/reg</span></p>
  </td>
  <td width=277 valign=top style='width:207.4pt;border:solid windowtext 1.0pt;
  border-left:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'>注册信息，网关启动时发送<span
  lang=EN-US>reg</span>给平台</p>
  </td>
 </tr>
 <tr>
  <td width=277 valign=top style='width:207.4pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span
  lang=EN-US>device_gateway/</span>网关序列号<span lang=EN-US>/server</span></p>
  </td>
  <td width=277 valign=top style='width:207.4pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'>平台发送给网关</p>
  </td>
 </tr>
 <tr>
  <td width=277 valign=top style='width:207.4pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span
  lang=EN-US>device_gateway/</span>网关序列号<span lang=EN-US>/client</span></p>
  </td>
  <td width=277 valign=top style='width:207.4pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'>网关发送给平台</p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>       </span>网关启动时额外发送<span lang=EN-US>reg</span>给“<span
lang=EN-US>device_gateway/reg</span>”供平台发现未知的网关。注册信息也同时发送到“<span lang=EN-US>device_gateway/</span>网关序列号<span
lang=EN-US>/server</span>”，因此如果不关注未知网关可以不订阅“<span lang=EN-US>device_gateway/reg</span>”的消息。</p>

<h1><a name="_Toc196505372"><span lang=EN-US>9<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>使用网关管理工具<span lang=EN-US>ManageTools</span></a></h1>

<h2><a name="_Toc196505373"><span lang=EN-US>9.1<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span>编译和配置</a></h2>

<p class=MsoNormal style='text-indent:21.0pt'>网关管理工具<span lang=EN-US>ManageTools</span>是<span
lang=EN-US>C# winforms</span>程序，用<span lang=EN-US>VS2022</span>打开<span
lang=EN-US>ManageTools.sln</span>，下载完依赖项后即可编译运行。</p>

<p class=MsoNormal style='text-indent:21.0pt'>项目很简单，主要是配置文件：</p>

<p class=MsoNormal><span lang=EN-US><img width=554 height=327
src="ctGateway_DeveloperGuide.files/image001.jpg"
alt="图形用户界面, 文本&#10;&#10;AI 生成的内容可能不正确。"></span></p>

<p class=MsoNormal><span lang=EN-US>       northConfig.json</span>和网关程序的配置文件完全一样（但没有默认配置文件）。</p>

<p class=MsoNormal><span lang=EN-US>       snList.txt</span>包含已知的网关序列号，格式为“序列号<span
lang=EN-US> name:</span>显示名称”。已经预设了开发用的网关序列号（网关上序列号来自<span lang=EN-US>home/sn.txt</span>）。</p>

<h2><a name="_Toc196505374"><span lang=EN-US>9.2<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span>启动</a></h2>

<p class=MsoNormal><span lang=EN-US>       </span>程序启动界面如下：</p>

<p class=MsoNormal><span lang=EN-US><img width=553 height=332
src="ctGateway_DeveloperGuide.files/image002.jpg"
alt="图形用户界面, 应用程序&#10;&#10;AI 生成的内容可能不正确。"></span></p>

<p class=MsoNormal><span lang=EN-US>       </span>支持多个配置，配置文件复制几个“<span
lang=EN-US>data</span>”，改为任何别的名字，网关管理工具自动检索所有配置。</p>

<h2><a name="_Toc196505375"><span lang=EN-US>9.3<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span>主界面</a></h2>

<p class=MsoNormal><span lang=EN-US>       </span>选择配置进入之后是这样：</p>

<p class=MsoNormal><span lang=EN-US><img width=553 height=332
src="ctGateway_DeveloperGuide.files/image003.jpg"
alt="图形用户界面, 应用程序, 表格&#10;&#10;AI 生成的内容可能不正确。"></span></p>

<p class=MsoNormal><span lang=EN-US>       </span>左边是网关列表，右边是网关的<span
lang=EN-US>MQTT</span>消息，包括了上下行消息，自动滚动。</p>

<h2><a name="_Toc196505376"><span lang=EN-US>9.4<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span>网关详情</a></h2>

<p class=MsoNormal style='margin-left:28.8pt'>在主界面双击左边列表的一个网关可以打开一个网关的详情窗口：</p>

<p class=MsoNormal><span lang=EN-US><img width=554 height=318
src="ctGateway_DeveloperGuide.files/image004.jpg"
alt="图形用户界面, 表格&#10;&#10;AI 生成的内容可能不正确。"></span></p>

<p class=MsoNormal><span lang=EN-US>       </span>大部分按钮直接对应交互协议的一种消息。这个界面只能对一个网关操作，主界面的按钮则是对选中的所有网关操作。</p>

<p class=MsoNormal><span lang=EN-US>       </span>左边是每条消息的基本情况，右边是消息内容。</p>

<h2><a name="_Toc196505377"><span lang=EN-US>9.5<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span>文件同步</a></h2>

<p class=MsoNormal><span lang=EN-US>       </span>“<span lang=EN-US>FileSync</span>”类似<span
lang=EN-US>FTP</span>，能查看网关上的文件的状态，能双向传输文件：</p>

<p class=MsoNormal><span lang=EN-US><img width=553 height=342
src="ctGateway_DeveloperGuide.files/image005.jpg"
alt="图片包含 图形用户界面&#10;&#10;AI 生成的内容可能不正确。"></span></p>

<h2><a name="_Toc196505378"><span lang=EN-US>9.6<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span>查看网关程序内部信息</a></h2>

<p class=MsoNormal style='margin-left:21.0pt'>按钮“<span lang=EN-US>Show</span>”会发送“<span
lang=EN-US>show</span>”指令给网关，网关会返回程序内部状态：</p>

<p class=MsoNormal><span lang=EN-US><img width=554 height=331 id="图片 1"
src="ctGateway_DeveloperGuide.files/image006.png" alt="图示&#10;&#10;AI 生成的内容可能不正确。"></span></p>

<p class=MsoNormal><span lang=EN-US>       </span>包含内部配置和解析配置时的一些重要信息（可以用来发现配置问题）。</p>

<h1><a name="_Toc196505379"><span lang=EN-US>10<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>源码指引</a></h1>

<h2><a name="_Toc196505380"><span lang=EN-US>10.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;
</span></span>编译<span lang=EN-US>ctfc</span></a></h2>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>Ctfc</span>的编译可以参考<span
lang=EN-US>ctfc</span>目录下的<span lang=EN-US>make.sh</span>：</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>cd platform</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>make -f makefile.mk
linux debug</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>cd ..</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>cd src</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>chmod 755 *.sh</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0F9ED5'>makeall.sh</span></p>

<p class=MsoNormal><span lang=EN-US>       </span>实际上就是先去<span lang=EN-US>platform</span>目录设置编译参数，然后去<span
lang=EN-US>strc</span>目录执行<span lang=EN-US>makeall.sh</span>。</p>

<p class=MsoNormal><span lang=EN-US>       makeall.sh</span>主要的功能是编译每个目录，而每个目录的编译方法是把<span
lang=EN-US>makefile.mk</span>复制为<span lang=EN-US>makefile</span>然后<span
lang=EN-US>make</span>。</p>

<p class=MsoNormal><span lang=EN-US>       </span>所以其实这个编译体系就是原生<span
lang=EN-US>make</span>，通过<span lang=EN-US>sh</span>实现了一点自动化。</p>

<h2><a name="_Toc196505381"><span lang=EN-US>10.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;
</span></span>编译<span lang=EN-US>gateway</span></a></h2>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>gateway</span>调用<span
lang=EN-US>ctfc</span>的编译体系，编译入口同样是<span lang=EN-US>makeall.sh</span>。</p>

<h2><a name="_Toc196505382"><span lang=EN-US>10.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;
</span></span>源码入口点</a></h2>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>gateway</span>的入口点在<span
lang=EN-US>gwmain</span>目录下的<span lang=EN-US>gwmain_t.cpp</span>的<span
lang=EN-US>main</span>函数。</p>

</div>

</body>

</html>
